# 碰撞检测

碰撞检测是检测物体之间是否/何时在何处发生碰撞.

为了检测两个运动物体之间的碰撞, 我们可以将其中一个物体作为参考系, 将问题转化为检测运动物体和静止物体之间的碰撞.

## 算法

### 分离轴定理 (separating axis theorem)

大多数碰撞检测系统都会使用该定理. 此定理指出, 若能找到一个轴, 两个凸形状在该轴上的投影不重叠, 则两个形状不相交. 若这样的轴不存在, 则两个形状相交. 该轴被称为**分离轴**.  
在二维空间下, 若能找到一条直线可以将两个形状完全隔离开, 则两个形状不重叠. 该直线被称为**分离线**, 在三维空间下被称为**分离面**.

这对于凹形状并不适用, 因为不相交的凹形状之间不一定可以以一条直线进行分割.

### GJK 算法

TODO.

## 碰撞过虑 (collision filtering)

TODO.

## 碰撞材质 (collision materials)

TODO.

## 高速运动物体的碰撞检测

当物体以高速运动或模拟步长过大时，两帧之间的状态变化可能很大，导致物体运动**不连贯**, 物体"跳跃着"前进可能出现隧穿 (tunneling) 现象. 例如, 子弹穿纸 (bullet throught paper) 就是一种容易产生隧穿现象的场景.  
前面使用的碰撞检测方法仅在物体能连贯运动时正常工作. 两个状态之间还存在其他无数个状态, 这些状态里物体之间可能发生了一或多次碰撞, 因此还需要将两个状态之间物体的变换纳入检测范围.

将子弹看成一个质点, 可以连接质点位置和当前质点位置, 即子弹的运动路径. 然后判断该线段是否与纸 (矩形) 相交.  
在给定时间内, 物体连续移动所覆盖的空间体积被称作"扫掠体 (swept volume)". 若将子弹看成球体, 则运动形成的扫掠体是一个胶囊体.

- 高速物体: 降低离散步长 -> 生成扫掠体.
- 慢速物体: 自己形成扫掠体.

绝对精确的模拟是不可能的, 扫掠体只是一种连贯运动的简化模型, 物体和扫掠体相交不一定代表物体之间发生了碰撞, 但是物体发生碰撞一定会和扫掠体相交.

## 性能优化

碰撞检测过程需要进行大量的计算, 因此对其进行优化是十分必要的.

### 碰撞体积 (bounding volumes)

**别名**: 包围体 (bounding box), 碰撞原型 (collision primitive).

参与碰撞检测的刚体可能具有复杂的外形, 将对性能造成严重的影响. 因此可以利用简化外形来提高碰撞检测的性能.  
使用碰撞体积(包围盒)来替代实际的外形进行碰撞检测. 碰撞体积通常由几个简单的几何图形组成, 因此可以使用简单快速的方法进行检测.  
碰撞体积通常具有以下特征:

- 高效的相交测试.
- 紧密的拟合.
- 易于旋转和变换.
- 内存占用少.

常见的碰撞体积有:

- [轴对齐包围盒](轴对齐包围盒.md).
- [圆形 (circle)](圆形与球体.md): 通常只适用于近似圆形的物体, 但针对这部分物体碰撞体积和实际外形可能十分接近, 与其他圆形包围盒相交检测简单快速.
- [球体 (sphere)](圆形与球体.md): 最简单的三维体积, 也是最高效的三维碰撞体积.
- 胶囊体 (capsule): 形似胶囊, 为线段扫掠球体(line swept sphere, LSS).
- 定向包围盒 (oriented bounding box, OBB).
- 离散定向多胞形 (discrete oriented polytope, DOP): k-DOP 是由 k 个平面构成的形状. AABB 与 OBB 都属于 6-POD (三维空间中).
- 多边形汤 (polygon soup/poly soup): 支持完全任意/非凸的形状. 常用于复杂的静态表面建模, 如地形和建筑.
- 复合形状 (compound shape): 由多个碰撞体积共同组成.

### 空间分区

### 阶段

将检测的过程大致分为三个阶段, 前两个阶段会剔除不需要检测的碰撞体. 最后一个阶段对剩余的碰撞体进行碰撞检测.

- 粗略阶段 (broad phase): 快速排除不需要检测的情况, 减少下一步的计算量.
- 精细阶段 (narrow phase): 对可能发生碰撞的物体进行碰撞检测和受力分析.

假设 n 个物体都可能和其他物体发生碰撞的情况下, 进行碰撞检测的时间复杂度为 O(n^2). 这意味着碰撞检测的耗时将会随着物体数量的增多成指数倍增长, 成为性能瓶颈. 因此在进行碰撞检测之前要先对物体进行筛选, 尽可能的挑选出必须要进行碰撞检测的物体, 以减少不必要的计算.

### 粗略阶段

通过物体之间的相对位置和相对速度以及空间分区等可以将其进行快速分类, 部分物体之间不可能发生碰撞就没有必要再进一步进行碰撞检测和受力分析.

- 排序和扫描 (sort and sweep).
- 空间分区 (spatial subdivision).

### 精细阶段

在对不可能发生碰撞的物体进行快速剔除后, 可能发生碰撞的物体将进行碰撞检测.

## 参考

- *Real-Time Collision Detection - Christer Ericson*.
- <https://developer.nvidia.com/gpugems/gpugems3/part-v-physics-simulation/chapter-32-broad-phase-collision-detection-cuda>.
